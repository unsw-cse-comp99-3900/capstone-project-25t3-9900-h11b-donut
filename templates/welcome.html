<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Welcome</title></head>
<body>
  <h1>Welcome，{{ identifier }}！</h1>

  <p>
    <a href="{{ url_for('choose_courses') }}"><button>Please select a course</button></a>
    <a href="{{ url_for('logout') }}"><button>logout</button></a>
  </p>

  <h2>Courses selected</h2>
  {% if courses and courses|length > 0 %}
    <ul>
      {% for item in courses %}
        <li>
          <a href="{{ url_for('show_my_material', course_code=item.course_code) }}">
            {{ item.course_code }}{% if item.course_name %} - {{ item.course_name }}{% endif %}
          </a>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>no courses recorded</p>
  {% endif %}

  <h2>Current preference（Semester：{{ semester }}）</h2>
  {% if pref %}
    <p>No.{{ pref.week_no }} Week（{% if pref.mode=='manual' %}manual{% else %}By default：from No.{{ pref.derived_from_week_no }} Week{% endif %}）</p>
    <ul>
      <li>Daily studying hours：{{ pref.daily_hours }}</li>
      <li>Weekly studying days：{{ pref.weekly_study_days }}</li>
      <li>Avoid studying days：{% if pref.avoid_days_list %}{{ pref.avoid_days_list|join(', ') }}{% else %}None:{% endif %}</li>
    </ul>
  {% else %}
    <p>No preference set</p>
  {% endif %}

  <!-- Generate Plan -->
  <h2>Generate Plan</h2>
  <p>Semester: {{ semester }} | Week: <strong id="week-no">{{ current_week }}</strong></p>
  <p><button type="button" id="btn-gen">Generate Plan</button></p>

  <form id="gen-panel" method="POST" action="/api/prefs/save"
        style="display:none; padding:10px; border:1px solid #ccc; max-width:520px;">
    <input type="hidden" name="week_no" id="week_no" value="{{ current_week }}">
    <input type="hidden" name="mode" id="mode" value="manual">

    <div style="margin-bottom:10px;">
      <label>Studying time per day：</label>
      <select id="daily_hours" name="daily_hours">
        {% for x in [0,0.5,1,1.5,2,2.5,3,3.5,4,4.5,5,5.5,6,6.5,7,7.5,8,9,10] %}
          <option value="{{ '%.1f' % x }}">{{ '%.1f' % x }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="margin-bottom:10px;">
      <label>Studying time per week：</label>
      <select id="weekly_days" name="weekly_study_days">
        {% for d in range(0,8) %}
          <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="margin-bottom:10px;">
      <label>Avoiding studying time(multiple choices)：</label><br>
      <select id="avoid_days" name="avoid_days" multiple size="7" style="min-width:200px;">
        <option value="Mon">Mon</option>
        <option value="Tue">Tue</option>
        <option value="Wed">Wed</option>
        <option value="Thu">Thu</option>
        <option value="Fri">Fri</option>
        <option value="Sat">Sat</option>
        <option value="Sun">Sun</option>
      </select>
    </div>

    {% if current_week > 1 %}
      <div style="margin-top:10px;">
        <button type="button" id="btn-default">Set default（same as last week）</button>
      </div>
    {% endif %}

    <div style="margin-top:14px;">
      <button type="submit" id="btn-confirm">Confirm</button>
      <a href="{{ url_for('welcome') }}"><button type="button">quit</button></a>
    </div>
  </form>

  <script>
    // 展开/收起
    document.getElementById('btn-gen').addEventListener('click', function() {
      const panel = document.getElementById('gen-panel');
      panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
      document.getElementById('mode').value = 'manual';
    });

    const dayBit = {Mon:1, Tue:2, Wed:4, Thu:8, Fri:16, Sat:32, Sun:64};

    {% if current_week > 1 %}
    document.getElementById('btn-default').addEventListener('click', async function() {
      const week = parseInt(document.getElementById('week-no').textContent, 10);
      try {
        const res = await fetch(`/api/prefs/prev?week_no=${week}`);
        if (!res.ok) { alert('No preference found for last week!'); return; }
        const json = await res.json();
        if (!json.ok) { alert('Preference of last week does not exist!'); return; }
        const d = json.data;

        document.getElementById('daily_hours').value = String(d.daily_hours);
        document.getElementById('weekly_days').value = String(d.weekly_study_days);

        const sel = document.getElementById('avoid_days');
        [...sel.options].forEach(opt => {
          const bit = dayBit[opt.value];
          opt.selected = ((d.avoid_days_bitmask & bit) === bit);
        });

        document.getElementById('mode').value = 'default';
      } catch (e) {
        console.error(e); alert('fail!');
      }
    });
    {% endif %}
  </script>
</body>
</html>
