<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .plan-item { margin: 5px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª å‰ç«¯Geminiæ ‡é¢˜æ˜¾ç¤ºæµ‹è¯•</h1>
    <div id="test-results"></div>
    
    <script>
        // æ¨¡æ‹Ÿåç«¯è¿”å›çš„AIè®¡åˆ’æ•°æ®
        const mockAiPlan = {
            ok: true,
            days: [
                {
                    date: '2025-11-05',
                    blocks: [
                        {
                            taskId: 'COMP9900_540003',
                            title: 'Part 1 - Setup & Planning',
                            minutes: 60
                        },
                        {
                            taskId: 'COMP9900_540003',
                            title: 'Part 2 - UI Implementation',
                            minutes: 60
                        },
                        {
                            taskId: 'COMP9900_540003',
                            title: 'Part 3 - Testing & Polish',
                            minutes: 60
                        }
                    ]
                }
            ],
            aiSummary: {
                tasks: [
                    {
                        taskId: 'COMP9900_540003',
                        taskTitle: 'COMP9900 - Assign1',
                        parts: [
                            { title: 'Part 1 - Setup & Planning', minutes: 60 },
                            { title: 'Part 2 - UI Implementation', minutes: 60 },
                            { title: 'Part 3 - Testing & Polish', minutes: 60 }
                        ]
                    }
                ]
            }
        };

        function testFrontendDisplay() {
            const resultsDiv = document.getElementById('test-results');
            
            resultsDiv.innerHTML += '<div class="info">ğŸš€ æµ‹è¯•å‰ç«¯æ•°æ®æ˜ å°„å’Œæ˜¾ç¤º...</div>';
            
            // æ¨¡æ‹Ÿå‰ç«¯çš„mapAiPlanToWeeklyPlanå‡½æ•°
            function mapAiPlanToWeeklyPlan(aiPlan) {
                const weekly = {};
                if (!aiPlan || !Array.isArray(aiPlan.days)) return weekly;

                // ä»»åŠ¡å…ƒä¿¡æ¯ç´¢å¼•
                const metaByTaskId = {};
                if (aiPlan.aiSummary?.tasks) {
                    for (const t of aiPlan.aiSummary.tasks) {
                        metaByTaskId[t.taskId] = {
                            taskTitle: t.taskTitle || t.taskId,
                            partsCount: Array.isArray(t.parts) ? t.parts.length : 0,
                        };
                    }
                }

                // å¤„ç†æ¯å¤©çš„blocks
                for (const day of aiPlan.days) {
                    const dateStr = day.date;
                    const offset = 0; // ç®€åŒ–ä¸ºå½“å‰å‘¨
                    if (!weekly[offset]) weekly[offset] = [];

                    for (const b of (day.blocks || [])) {
                        const taskId = b.taskId;
                        const courseId = taskId.split('_')[0] || taskId;
                        const meta = metaByTaskId[taskId] || { taskTitle: taskId, partsCount: 0 };

                        const item = {
                            id: `${courseId}-${taskId}`,
                            courseId,
                            courseTitle: meta.taskTitle,
                            partTitle: b.title,  // è¿™é‡Œæ˜¯Geminiç”Ÿæˆçš„æ ‡é¢˜
                            minutes: b.minutes,
                            date: dateStr,
                            color: '#4A90E2',
                            completed: false
                        };

                        console.log(`ğŸ” æ˜ å°„æ ‡é¢˜: ${b.title}`);
                        weekly[offset].push(item);
                    }
                }

                return weekly;
            }

            // æµ‹è¯•æ•°æ®æ˜ å°„
            const weeklyPlan = mapAiPlanToWeeklyPlan(mockAiPlan);
            
            resultsDiv.innerHTML += '<div class="success">âœ… æ•°æ®æ˜ å°„å®Œæˆ</div>';
            
            // æ˜¾ç¤ºæ˜ å°„ç»“æœ
            const planItems = weeklyPlan[0] || [];
            resultsDiv.innerHTML += `<div class="info">ğŸ“‹ æ˜ å°„å¾—åˆ° ${planItems.length} ä¸ªè®¡åˆ’é¡¹:</div>`;
            
            planItems.forEach((item, index) => {
                const isGeminiTitle = item.partTitle.includes('Part') && item.partTitle.includes('-');
                const statusClass = isGeminiTitle ? 'success' : 'error';
                const statusIcon = isGeminiTitle ? 'âœ…' : 'âŒ';
                
                resultsDiv.innerHTML += `
                    <div class="plan-item ${statusClass}">
                        <strong>é¡¹ç›® ${index + 1}:</strong> ${item.courseTitle}<br>
                        <strong>Partæ ‡é¢˜:</strong> ${item.partTitle} ${statusIcon}<br>
                        <strong>æ—¶é•¿:</strong> ${item.minutes} åˆ†é’Ÿ<br>
                        <strong>æ—¥æœŸ:</strong> ${item.date}
                    </div>
                `;
            });
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ ‡é¢˜éƒ½æ˜¯Geminiæ ¼å¼
            const geminiTitles = planItems.filter(item => 
                item.partTitle.includes('Part') && item.partTitle.includes('-')
            );
            
            if (geminiTitles.length === planItems.length && planItems.length > 0) {
                resultsDiv.innerHTML += '<div class="success">ğŸ‰ æ‰€æœ‰æ ‡é¢˜éƒ½æ˜¯Geminiç”Ÿæˆçš„ç‰¹å®šæ ¼å¼!</div>';
            } else {
                resultsDiv.innerHTML += `<div class="error">âš ï¸ åªæœ‰ ${geminiTitles.length}/${planItems.length} ä¸ªæ ‡é¢˜æ˜¯Geminiæ ¼å¼</div>`;
            }
            
            resultsDiv.innerHTML += '<div class="info">ğŸ’¡ å¦‚æœå‰ç«¯æ˜¾ç¤ºçš„ä¸æ˜¯è¿™äº›æ ‡é¢˜ï¼Œå¯èƒ½æ˜¯ç¼“å­˜é—®é¢˜æˆ–æ•°æ®æµé—®é¢˜</div>';
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨æµ‹è¯•
        window.onload = testFrontendDisplay;
    </script>
</body>
</html>